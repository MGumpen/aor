@model AOR.Models.Data.ObstacleData
@using System.Security.Claims
@{
    ViewData["Title"] = "Register Obstacle";
    Layout = "_Layout";
    
    string obstacleType = ViewBag.ObstacleType ?? "other";
    string coordinatesJson = ViewBag.Coordinates ?? "[]";
    int pointCount = ViewBag.PointCount ?? 0;
    string? draftKey = Context.Request.Query["draft"];
    string currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier) ?? string.Empty;
}

<link rel="stylesheet" href="~/css/Obstacle/DataForm.css" />

<section class="pilot-form-container">
    <div class="pilot-form-header">
        <h1>
            <span id="summaryTypeHeading">@obstacleType.ToUpper()</span> Registration
            <span id="summaryTypeBadge" class="obstacle-type-badge badge-@obstacleType.ToLower()">@obstacleType</span>
        </h1>
        <p>Complete the registration for your @obstacleType.ToLower() obstacle with @pointCount point(s)</p>
    </div>
    <div class="obstacle-info">
        <h3>Map Data Summary</h3>
    <p><strong>Type:</strong> <span id="summaryTypeText">@obstacleType.ToUpper()</span></p>
    <p><strong>Points:</strong> <span id="summaryPointCount">@pointCount</span> coordinate(s)</p>
        
        <div class="coordinates-list">
            <strong>Coordinates:</strong>
            <div id="coordinates-display"></div>
        </div>
    </div>

    <form asp-controller="Obstacle" asp-action="DataForm" method="post">
        @Html.AntiForgeryToken()
        
        @if (!string.IsNullOrWhiteSpace(draftKey))
        {
            <input type="hidden" name="draft" value="@draftKey" />
        }
        <input type="hidden" name="ObstacleType" id="hiddenObstacleType" value="@obstacleType" />
        <input type="hidden" name="Coordinates" id="hiddenCoordinates" value="@coordinatesJson" />
        <input type="hidden" name="PointCount" id="hiddenPointCount" value="@pointCount" />
        <input type="hidden" id="currentDraftKey" value="" />
        <input type="hidden" name="heightUnit" value="feet" />
        <input type="hidden" id="currentUserId" value="@currentUserId" />

        <div class="form-grid">
            @if (obstacleType.ToLower() == "line") {
                <div class="form-row">
                    <label class="pilot-label">Line Name/ID <span style="color: red;">*</span></label>
                    <input asp-for="ObstacleName" class="pilot-input" placeholder="e.g., Main Line A" maxlength="50" required />
                    <span class="pilot-help">Enter the line identification</span>
                    <span asp-validation-for="ObstacleName" class="pilot-validation"></span>
                </div>
                
                <div class="form-row">
                    <label class="pilot-label">Wire Height <span style="color: red;">*</span></label>
                    <div class="height-input-container">
                        <div class="height-input-wrapper">
                <input type="number" step="0.1" min="0.1" max="3280" class="pilot-input" 
                    id="heightInput" name="heightInput" placeholder="e.g., 50.8" required />
                            <span class="unit-label">ft</span>
                        </div>
                        <div id="conversionDisplay" class="conversion-display">≈ 0.0 m</div>
                    </div>
                    <input type="hidden" asp-for="ObstacleHeight" id="hiddenHeight" />
                    <span class="pilot-help">Height in feet (meters shown for reference)</span>
                    <span asp-validation-for="ObstacleHeight" class="pilot-validation"></span>
                </div>
                
                <div class="form-row">
                    <label class="pilot-label">Number of Wires</label>
                    <input name="WireCount" type="number" min="1" max="99" class="pilot-input" placeholder="e.g., 3" />
                </div>
            }
            else if (obstacleType.ToLower() == "mast") {
                <div class="form-row">
                    <label class="pilot-label">Mast Name/ID <span style="color: red;">*</span></label>
                    <input asp-for="ObstacleName" class="pilot-input" placeholder="e.g., Communication Tower 1" maxlength="50" required />
                    <span class="pilot-help">Enter the mast identification</span>
                    <span asp-validation-for="ObstacleName" class="pilot-validation"></span>
                </div>
                
                <div class="form-row">
                    <label class="pilot-label">Height <span style="color: red;">*</span></label>
                    <div class="height-input-container">
                        <div class="height-input-wrapper">
                <input type="number" step="0.1" min="0.1" max="3280" class="pilot-input" 
                    id="heightInput" name="heightInput" placeholder="e.g., 147.6" required />
                            <span class="unit-label">ft</span>
                        </div>
                        <div id="conversionDisplay" class="conversion-display">≈ 0.0 m</div>
                    </div>
                    <input type="hidden" asp-for="ObstacleHeight" id="hiddenHeight" />
                    <span class="pilot-help">Height in feet (meters shown for reference)</span>
                    <span asp-validation-for="ObstacleHeight" class="pilot-validation"></span>
                </div>
                
                <div class="form-row">
                    <label class="pilot-label">Mast Type</label>
                    <select name="MastType" class="pilot-select">
                        <option value="">Select type</option>
                        <option value="communication">Communication Tower</option>
                        <option value="radio">Radio Mast</option>
                        <option value="cellular">Cell Tower</option>
                        <option value="meteorological">Weather Mast</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <label class="pilot-label">Has Lighting?</label>
                    <select name="HasLighting" class="pilot-select">
                        <option value="">Select</option>
                        <option value="true">Yes - Has Aviation Lighting</option>
                        <option value="false">No - No Lighting</option>
                    </select>
                </div>
            }
            else {
                <div class="form-row">
                    <label class="pilot-label">Obstacle Name <span style="color: red;">*</span></label>
                    <input asp-for="ObstacleName" class="pilot-input" placeholder="e.g., Wind Turbine, Building, etc." maxlength="50" required />
                    <span class="pilot-help">Name or description of the obstacle</span>
                    <span asp-validation-for="ObstacleName" class="pilot-validation"></span>
                </div>
                
                <div class="form-row">
                    <label class="pilot-label">Height <span style="color: red;">*</span></label>
                    <div class="height-input-container">
                        <div class="height-input-wrapper">
                <input type="number" step="0.1" min="0.1" max="3280" class="pilot-input" 
                    id="heightInput" name="heightInput" placeholder="e.g., 82.0" required />
                            <span class="unit-label">ft</span>
                        </div>
                        <div id="conversionDisplay" class="conversion-display">≈ 0.0 m</div>
                    </div>
                    <input type="hidden" asp-for="ObstacleHeight" id="hiddenHeight" />
                    <span class="pilot-help">Height in feet (meters shown for reference)</span>
                    <span asp-validation-for="ObstacleHeight" class="pilot-validation"></span>
                </div>
                
                <div class="form-row">
                    <label class="pilot-label">Obstacle Category</label>
                    <select name="Category" class="pilot-select">
                        <option value="">Select category</option>
                        <option value="building">Building/Structure</option>
                        <option value="tree">Tree/Vegetation</option>
                        <option value="terrain">Terrain/Hill</option>
                        <option value="vehicle">Vehicle/Equipment</option>
                        <option value="temporary">Temporary Structure</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            }

            <div class="form-row wide">
                <label class="pilot-label">
                    Additional Description
                    @if (obstacleType.ToLower() == "other") {
                        <span style="color: red;">*</span>
                    }
                </label>
                @if (obstacleType.ToLower() == "other") {
                    <textarea asp-for="ObstacleDescription" rows="4" class="pilot-textarea" maxlength="1000"
                              placeholder="Additional details, hazards, or important notes..." required></textarea>
                } else {
                    <textarea asp-for="ObstacleDescription" rows="4" class="pilot-textarea" maxlength="1000"
                              placeholder="Additional details, hazards, or important notes..."></textarea>
                }
                <span class="pilot-help">
                    @if (obstacleType.ToLower() == "other") {
                        <text>Description is required for Other obstacle types</text>
                    } else {
                        <text>Any additional information that might be relevant for aviation safety</text>
                    }
                </span>
                <span asp-validation-for="ObstacleDescription" class="pilot-validation"></span>
            </div>
        </div>

        <div class="pilot-actions">
            <a href="/Crew" class="btn btn-cancel">Cancel</a>
            <button type="button" class="btn btn-draft" onclick="saveDraft()">Save as Draft</button>
            <button type="submit" class="btn btn-primary">Register Obstacle</button>
        </div>
    </form>
</section>

<!-- Form toast notification -->
<div id="formNotification" class="form-toast-notification" role="status" aria-live="polite">
    Report registered!
</div>

<div id="draftNotification" class="draft-saved-notification" role="status" aria-live="polite">
    Draft saved successfully!
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/Obstacle/DataForm.js"></script>
}
