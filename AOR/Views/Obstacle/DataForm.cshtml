@model AOR.Models.ObstacleData
@{
    ViewData["Title"] = "Register Obstacle";
    Layout = "_Layout";
    
    string obstacleType = ViewBag.ObstacleType ?? "other";
    string coordinatesJson = ViewBag.Coordinates ?? "[]";
    int pointCount = ViewBag.PointCount ?? 0;
}

<style>
    .pilot-form-container {
        max-width: 800px;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 24px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        padding: 24px;
        border: 1px solid #e5e7eb;
    }
    .pilot-form-header h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 6px;
    }
    .pilot-form-header p {
        color: #6b7280;
        margin: 0;
    }
    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
    }
    .form-row {
        grid-column: span 1;
    }
    .form-row.wide {
        grid-column: span 2;
    }
    .pilot-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
    }
    .pilot-input, .pilot-textarea, .pilot-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        outline: none;
        box-sizing: border-box;
    }
    .pilot-input:focus, .pilot-textarea:focus, .pilot-select:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79,70,229,0.15);
    }
    .pilot-validation {
        color: #dc2626;
        font-size: 0.875rem;
        margin-top: 4px;
        display: block;
    }
    .pilot-help {
        display: block;
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 6px;
    }
    .obstacle-info {
        background-color: #f0f9ff;
        border: 1px solid #0ea5e9;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
    }
    .obstacle-info h3 {
        color: #0c4a6e;
        margin: 0 0 8px 0;
        font-size: 1.1rem;
    }
    .coordinates-list {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 12px;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
    }
    .coordinate-item {
        margin-bottom: 4px;
        padding: 4px 8px;
        background-color: white;
        border-radius: 4px;
        border-left: 3px solid #3b82f6;
    }
    .pilot-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 20px;
        justify-content: flex-start;
    }
    .pilot-primary {
        background-color: #4338ca;
        color: #fff;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
    }
    .pilot-secondary {
        background: #f3f4f6;
        border: 1px solid #9ca3af;
        color: #374151;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
    }
    .obstacle-type-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
        margin-left: 10px;
    }
    
    .badge-powerline { background: #fee2e2; color: #dc2626; }
    .badge-mast { background: #dbeafe; color: #2563eb; }
    .badge-other { background: #d1fae5; color: #059669; }

    /* Height input specific styles */
    .height-input-container {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .height-input-wrapper {
        flex: 1;
        position: relative;
    }
    
    .height-input-wrapper input {
            padding-right: 35px !important; /* Override default padding */
        }

    .unit-label {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
        font-size: 0.875rem;
        pointer-events: none;
        font-weight: 500;
         z-index: 1;
    }
    
    .conversion-display {
        padding: 8px 12px;
        background: #f9fafb;
        border-radius: 6px;
        min-width: 100px;
        text-align: center;
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
        border: 1px solid #e5e7eb;
    }
    
    .pilot-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        justify-content: flex-end;
    }
    
    .pilot-primary, .pilot-secondary, .pilot-draft {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        min-width: 120px;
    }
    
    .pilot-primary {
        background: #4f46e5;
        color: white;
    }
    
    .pilot-primary:hover {
        background: #4338ca;
    }
    
    .pilot-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
    }
    
    .pilot-secondary:hover {
        background: #e5e7eb;
    }
    
    .pilot-draft {
        background: #fbbf24;
        color: #92400e;
        border: 1px solid #f59e0b;
    }
    
    .pilot-draft:hover {
        background: #f59e0b;
        color: white;
    }
    
    .draft-saved-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
    }
    
    .draft-saved-notification.show {
        opacity: 1;
        transform: translateY(0);
    }
</style>

<section class="pilot-form-container">
    <div class="pilot-form-header">
        <h1>
            <span id="summaryTypeHeading">@obstacleType.ToUpper()</span> Registration
            <span id="summaryTypeBadge" class="obstacle-type-badge badge-@obstacleType.ToLower()">@obstacleType</span>
        </h1>
        <p>Complete the registration for your @obstacleType.ToLower() obstacle with @pointCount point(s)</p>
    </div>

    <div class="obstacle-info">
        <h3>Map Data Summary</h3>
    <p><strong>Type:</strong> <span id="summaryTypeText">@obstacleType.ToUpper()</span></p>
    <p><strong>Points:</strong> <span id="summaryPointCount">@pointCount</span> coordinate(s)</p>
        
        @if (pointCount > 0) {
            <div class="coordinates-list">
                <strong>Coordinates:</strong>
                <div id="coordinates-display"></div>
            </div>
        }
    </div>

    <form asp-controller="Obstacle" asp-action="DataForm" method="post">
        <!-- Hidden fields -->
    <input type="hidden" name="ObstacleType" id="hiddenObstacleType" value="@obstacleType" />
    <input type="hidden" name="Coordinates" id="hiddenCoordinates" value="@coordinatesJson" />
    <input type="hidden" name="PointCount" id="hiddenPointCount" value="@pointCount" />
    <input type="hidden" id="currentDraftKey" value="" />
        <input type="hidden" name="heightUnit" value="feet" />

        <div class="form-grid">
            @if (obstacleType.ToLower() == "powerline") {
                <div class="form-row">
                    <label class="pilot-label">Power Line Name/ID</label>
                    <input asp-for="ObstacleName" class="pilot-input" placeholder="e.g., Main Power Line A" required />
                    <span class="pilot-help">Enter the power line identification</span>
                    <span asp-validation-for="ObstacleName" class="pilot-validation"></span>
                </div>
                
                <div class="form-row">
                    <label class="pilot-label">Wire Height</label>
                    <div class="height-input-container">
                        <div class="height-input-wrapper">
                            <input type="number" step="0.1" min="0.1" class="pilot-input" 
                                   id="heightInput" name="heightInput" placeholder="e.g., 50.8" required />
                            <span class="unit-label">ft</span>
                        </div>
                        <div id="conversionDisplay" class="conversion-display">≈ 0.0 m</div>
                    </div>
                    <input type="hidden" asp-for="ObstacleHeight" id="hiddenHeight" />
                    <span class="pilot-help">Height in feet (meters shown for reference)</span>
                    <span asp-validation-for="ObstacleHeight" class="pilot-validation"></span>
                </div>
                
                <div class="form-row">
                    <label class="pilot-label">Number of Wires</label>
                    <input name="WireCount" type="number" min="1" class="pilot-input" placeholder="e.g., 3" />
                </div>
            }
            else if (obstacleType.ToLower() == "mast") {
                <div class="form-row">
                    <label class="pilot-label">Mast Name/ID</label>
                    <input asp-for="ObstacleName" class="pilot-input" placeholder="e.g., Communication Tower 1" required />
                    <span class="pilot-help">Enter the mast identification</span>
                    <span asp-validation-for="ObstacleName" class="pilot-validation"></span>
                </div>
                
                <div class="form-row">
                    <label class="pilot-label">Height</label>
                    <div class="height-input-container">
                        <div class="height-input-wrapper">
                            <input type="number" step="0.1" min="0.1" class="pilot-input" 
                                   id="heightInput" name="heightInput" placeholder="e.g., 147.6" required />
                            <span class="unit-label">ft</span>
                        </div>
                        <div id="conversionDisplay" class="conversion-display">≈ 0.0 m</div>
                    </div>
                    <input type="hidden" asp-for="ObstacleHeight" id="hiddenHeight" />
                    <span class="pilot-help">Height in feet (meters shown for reference)</span>
                    <span asp-validation-for="ObstacleHeight" class="pilot-validation"></span>
                </div>
                
                <div class="form-row">
                    <label class="pilot-label">Mast Type</label>
                    <select name="MastType" class="pilot-select">
                        <option value="">Select type</option>
                        <option value="communication">Communication Tower</option>
                        <option value="radio">Radio Mast</option>
                        <option value="cellular">Cell Tower</option>
                        <option value="meteorological">Weather Mast</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <label class="pilot-label">Has Lighting?</label>
                    <select name="HasLighting" class="pilot-select">
                        <option value="">Select</option>
                        <option value="true">Yes - Has Aviation Lighting</option>
                        <option value="false">No - No Lighting</option>
                    </select>
                </div>
            }
            else {
                <div class="form-row">
                    <label class="pilot-label">Obstacle Name</label>
                    <input asp-for="ObstacleName" class="pilot-input" placeholder="e.g., Wind Turbine, Building, etc." required />
                    <span class="pilot-help">Name or description of the obstacle</span>
                    <span asp-validation-for="ObstacleName" class="pilot-validation"></span>
                </div>
                
                <div class="form-row">
                    <label class="pilot-label">Height</label>
                    <div class="height-input-container">
                        <div class="height-input-wrapper">
                            <input type="number" step="0.1" min="0.1" class="pilot-input" 
                                   id="heightInput" name="heightInput" placeholder="e.g., 82.0" required />
                            <span class="unit-label">ft</span>
                        </div>
                        <div id="conversionDisplay" class="conversion-display">≈ 0.0 m</div>
                    </div>
                    <input type="hidden" asp-for="ObstacleHeight" id="hiddenHeight" />
                    <span class="pilot-help">Height in feet (meters shown for reference)</span>
                    <span asp-validation-for="ObstacleHeight" class="pilot-validation"></span>
                </div>
                
                <div class="form-row">
                    <label class="pilot-label">Obstacle Category</label>
                    <select name="Category" class="pilot-select">
                        <option value="">Select category</option>
                        <option value="building">Building/Structure</option>
                        <option value="tree">Tree/Vegetation</option>
                        <option value="terrain">Terrain/Hill</option>
                        <option value="vehicle">Vehicle/Equipment</option>
                        <option value="temporary">Temporary Structure</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            }

            <div class="form-row wide">
                <label class="pilot-label">
                    Additional Description
                    @if (obstacleType.ToLower() == "other") {
                        <span style="color: red;">*</span>
                    }
                </label>
                @if (obstacleType.ToLower() == "other") {
                    <textarea asp-for="ObstacleDescription" rows="4" class="pilot-textarea" 
                              placeholder="Additional details, hazards, or important notes..." required></textarea>
                } else {
                    <textarea asp-for="ObstacleDescription" rows="4" class="pilot-textarea" 
                              placeholder="Additional details, hazards, or important notes..."></textarea>
                }
                <span class="pilot-help">
                    @if (obstacleType.ToLower() == "other") {
                        <text>Description is required for Other obstacle types</text>
                    } else {
                        <text>Any additional information that might be relevant for aviation safety</text>
                    }
                </span>
                <span asp-validation-for="ObstacleDescription" class="pilot-validation"></span>
            </div>
        </div>

        <div class="pilot-actions">
            <a href="/Crew" class="pilot-secondary">Cancel</a>
            <button type="button" class="pilot-draft" onclick="saveDraft()">Save as Draft</button>
            <button type="submit" class="pilot-primary">Register Obstacle</button>
        </div>
    </form>
</section>

<!-- Draft saved notification -->
<div id="draftNotification" class="draft-saved-notification">
    Draft saved successfully!
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const initialCoordinatesJson = '@Html.Raw(coordinatesJson)';
        let heightInputElement;
        let conversionDisplayElement;
        let hiddenHeightElement;

        document.addEventListener('DOMContentLoaded', function () {
            heightInputElement = document.getElementById('heightInput');
            conversionDisplayElement = document.getElementById('conversionDisplay');
            hiddenHeightElement = document.getElementById('hiddenHeight');

            if (heightInputElement) {
                heightInputElement.addEventListener('input', updateHeightConversion);
                updateHeightConversion();
            }

            renderCoordinatesFromJson(initialCoordinatesJson);
            updateMapSummaryFromData({
                ObstacleType: document.getElementById('hiddenObstacleType')?.value,
                PointCount: document.getElementById('hiddenPointCount')?.value,
                Coordinates: initialCoordinatesJson
            });

            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', updateHeightConversion);
            }

            loadDraft();
        });

        function updateHeightConversion() {
            if (!heightInputElement || !conversionDisplayElement || !hiddenHeightElement) {
                return;
            }

            const inputValue = parseFloat(heightInputElement.value);
            if (!isNaN(inputValue) && inputValue > 0) {
                const meters = inputValue * 0.3048;
                conversionDisplayElement.textContent = `≈ ${meters.toFixed(1)} m`;
                hiddenHeightElement.value = meters;
            } else {
                conversionDisplayElement.textContent = '≈ 0.0 m';
                hiddenHeightElement.value = '';
            }
        }

        function renderCoordinatesFromJson(json) {
            const display = document.getElementById('coordinates-display');
            if (!display) {
                return;
            }

            if (!json || json === '[]') {
                display.innerHTML = '<div class="coordinate-item">No coordinates registered yet.</div>';
                return;
            }

            let parsed;
            if (typeof json === 'string') {
                try {
                    parsed = JSON.parse(json);
                } catch (error) {
                    console.warn('Unable to parse coordinates', error);
                    display.innerHTML = '<div class="coordinate-item">Error parsing coordinates</div>';
                    return;
                }
            } else {
                parsed = json;
            }

            if (!Array.isArray(parsed) || !parsed.length) {
                display.innerHTML = '<div class="coordinate-item">No coordinates registered yet.</div>';
                return;
            }

            display.innerHTML = parsed.map((coord, index) => {
                const lat = typeof coord.lat === 'number' ? coord.lat.toFixed(6) : 'N/A';
                const lng = typeof coord.lng === 'number' ? coord.lng.toFixed(6) : 'N/A';
                return `<div class="coordinate-item">Point ${index + 1}: ${lat}, ${lng}</div>`;
            }).join('');
        }

        function derivePointCount(data) {
            if (!data) {
                return 0;
            }

            const countFromField = Number(data.PointCount);
            if (!Number.isNaN(countFromField) && countFromField > 0) {
                return countFromField;
            }

            if (data.Coordinates) {
                try {
                    const coordinates = typeof data.Coordinates === 'string'
                        ? JSON.parse(data.Coordinates)
                        : data.Coordinates;

                    if (Array.isArray(coordinates)) {
                        return coordinates.length;
                    }
                } catch (error) {
                    console.warn('Unable to parse coordinate data for point count', error);
                }
            }

            return 0;
        }

        function setFieldValueByName(name, value) {
            if (value === undefined || value === null) {
                return;
            }

            const field = document.querySelector(`[name="${name}"]`);
            if (!field) {
                return;
            }

            if (field.type === 'checkbox') {
                const normalized = typeof value === 'string' ? value.trim().toLowerCase() : value;
                field.checked = normalized === true || normalized === 'true' || normalized === '1';
                return;
            }

            if (field.type === 'radio') {
                const target = Array.from(document.querySelectorAll(`input[type="radio"][name="${name}"]`))
                    .find(radio => radio.value === value.toString());
                if (target) {
                    target.checked = true;
                }
                return;
            }

            const normalizedValue = typeof value === 'string' ? value : value.toString();
            field.value = normalizedValue;
        }

        function applyDraftToForm(data) {
            setFieldValueByName('ObstacleName', data.ObstacleName);
            setFieldValueByName('ObstacleDescription', data.ObstacleDescription);
            setFieldValueByName('heightInput', data.heightInput);
            setFieldValueByName('ObstacleHeight', data.ObstacleHeight);
            setFieldValueByName('WireCount', data.WireCount);
            setFieldValueByName('MastType', data.MastType);
            if (data.HasLighting !== undefined) {
                setFieldValueByName('HasLighting', data.HasLighting);
            }
            setFieldValueByName('Category', data.Category);

            if (heightInputElement && typeof data.heightInput !== 'undefined') {
                heightInputElement.value = data.heightInput;
            }

            if (hiddenHeightElement && typeof data.ObstacleHeight !== 'undefined') {
                hiddenHeightElement.value = data.ObstacleHeight;
            }

            const hiddenCoordinatesField = document.getElementById('hiddenCoordinates');
            if (hiddenCoordinatesField && typeof data.Coordinates !== 'undefined') {
                hiddenCoordinatesField.value = typeof data.Coordinates === 'string'
                    ? data.Coordinates
                    : JSON.stringify(data.Coordinates ?? []);
            }

            const hiddenPointCountField = document.getElementById('hiddenPointCount');
            if (hiddenPointCountField && typeof data.PointCount !== 'undefined') {
                hiddenPointCountField.value = data.PointCount;
            }

            const hiddenTypeField = document.getElementById('hiddenObstacleType');
            if (hiddenTypeField && typeof data.ObstacleType !== 'undefined') {
                hiddenTypeField.value = data.ObstacleType.toString();
            }

            if (data.Coordinates) {
                renderCoordinatesFromJson(data.Coordinates);
            }

            updateHeightConversion();
            updateMapSummaryFromData(data);
        }

        function canonicalizeDraftData(source = {}) {
            const data = { ...source };

            const getFirstValue = (...keys) => {
                for (const key of keys) {
                    if (Object.prototype.hasOwnProperty.call(data, key)) {
                        const value = data[key];
                        if (value !== undefined && value !== null) {
                            if (typeof value === 'string') {
                                const trimmed = value.trim();
                                if (trimmed !== '') {
                                    return trimmed;
                                }
                            } else if (!(typeof value === 'number' && Number.isNaN(value))) {
                                return value;
                            }
                        }
                    }
                }

                return undefined;
            };

            const setCanonicalField = (canonicalKey, ...aliases) => {
                const value = getFirstValue(canonicalKey, ...aliases);
                if (value !== undefined) {
                    data[canonicalKey] = value;
                }
            };

            setCanonicalField('ObstacleName', 'obstacleName', 'name', 'ObstacleId', 'obstacleId', 'draftTitle', 'title');
            setCanonicalField('ObstacleType', 'obstacleType', 'type');
            setCanonicalField('ObstacleDescription', 'obstacleDescription', 'description');
            setCanonicalField('ObstacleHeight', 'obstacleHeight', 'heightMeters', 'height', 'Height');
            setCanonicalField('heightInput', 'heightFeet', 'HeightFeet', 'height_ft', 'feetHeight');
            setCanonicalField('WireCount', 'wireCount', 'wires', 'wire_count', 'numberOfWires', 'wireTotal');
            setCanonicalField('MastType', 'mastType', 'towerType', 'mast_type', 'tower_type');
            setCanonicalField('HasLighting', 'hasLighting', 'lighting', 'Lighting', 'has_lighting');
            setCanonicalField('Category', 'category', 'obstacleCategory', 'obstacle_category');
            setCanonicalField('Coordinates', 'coordinates', 'pointsJson');
            setCanonicalField('PointCount', 'pointCount', 'points');
            setCanonicalField('savedAt', 'SavedAt', 'saved_at');

            if (data.ObstacleType) {
                data.ObstacleType = data.ObstacleType.toString();
            }

            if (typeof data.HasLighting === 'boolean') {
                data.HasLighting = data.HasLighting ? 'true' : 'false';
            } else if (typeof data.HasLighting === 'string') {
                const trimmed = data.HasLighting.trim().toLowerCase();
                if (trimmed === 'yes') {
                    data.HasLighting = 'true';
                } else if (trimmed === 'no') {
                    data.HasLighting = 'false';
                } else {
                    data.HasLighting = data.HasLighting.trim();
                }
            }

            if (data.Coordinates && typeof data.Coordinates !== 'string') {
                try {
                    data.Coordinates = JSON.stringify(data.Coordinates);
                } catch (error) {
                    console.warn('Unable to stringify coordinates during canonicalization', error);
                    data.Coordinates = '[]';
                }
            }

            const parsedHeight = Number(data.ObstacleHeight);
            if (!Number.isNaN(parsedHeight) && parsedHeight > 0) {
                data.ObstacleHeight = parsedHeight;
            }

            if ((!data.heightInput || data.heightInput === '') && parsedHeight > 0) {
                const feet = parsedHeight / 0.3048;
                data.heightInput = (Math.round(feet * 10) / 10).toString();
            }

            data.PointCount = derivePointCount(data);

            ['ObstacleName', 'ObstacleDescription', 'MastType', 'Category', 'WireCount', 'heightInput'].forEach(key => {
                if (typeof data[key] === 'string') {
                    data[key] = data[key].trim();
                }
            });

            return data;
        }

        function buildDraftData(options = {}) {
            const form = document.querySelector('form');
            if (!form) {
                return null;
            }

            updateHeightConversion();

            const formData = new FormData(form);
            const draftData = {};

            formData.forEach((value, key) => {
                if (key === '__RequestVerificationToken') {
                    return;
                }
                draftData[key] = value;
            });

            const canonicalDraft = canonicalizeDraftData(draftData);

            if (canonicalDraft.ObstacleName) {
                canonicalDraft.ObstacleName = canonicalDraft.ObstacleName.toString().trim();
            }

            if (!canonicalDraft.ObstacleName && draftData.ObstacleName) {
                canonicalDraft.ObstacleName = draftData.ObstacleName.toString().trim();
            }

            if (!canonicalDraft.ObstacleType) {
                const typeField = document.getElementById('hiddenObstacleType');
                if (typeField && typeField.value) {
                    canonicalDraft.ObstacleType = typeField.value;
                }
            }

            const coordinatesField = document.getElementById('hiddenCoordinates');
            if (coordinatesField) {
                canonicalDraft.Coordinates = coordinatesField.value;
            }

            if (hiddenHeightElement && hiddenHeightElement.value) {
                const meters = Number(hiddenHeightElement.value);
                if (!Number.isNaN(meters) && meters > 0) {
                    canonicalDraft.ObstacleHeight = meters;
                }
            }

            if (heightInputElement) {
                canonicalDraft.heightInput = heightInputElement.value || canonicalDraft.heightInput || '';
            }

            canonicalDraft.PointCount = derivePointCount(canonicalDraft);
            canonicalDraft.savedAt = new Date().toISOString();
            canonicalDraft.isDraft = true;
            canonicalDraft.autoSaved = Boolean(options.autoSave);

            const existingKey = document.getElementById('currentDraftKey')?.value;
            const typeSegment = (canonicalDraft.ObstacleType || 'obstacle').toLowerCase().replace(/\s+/g, '-');
            const draftKey = existingKey || `draft_${typeSegment}_${Date.now()}`;
            canonicalDraft.draftKey = draftKey;

            return canonicalDraft;
        }

        function saveDraft() {
            const draftData = buildDraftData();
            if (!draftData) {
                return;
            }

            localStorage.setItem(draftData.draftKey, JSON.stringify(draftData));

            const currentDraftKeyField = document.getElementById('currentDraftKey');
            if (currentDraftKeyField) {
                currentDraftKeyField.value = draftData.draftKey;
            }

            showDraftNotification();

            setTimeout(() => {
                window.location.href = '/Crew';
            }, 1000);
        }

        function showDraftNotification() {
            const notification = document.getElementById('draftNotification');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Load draft data if available
        function loadDraft() {
            const urlParams = new URLSearchParams(window.location.search);
            const draftKey = urlParams.get('draft');
            
            if (draftKey) {
                const draftData = localStorage.getItem(draftKey);
                if (draftData) {
                    try {
                        const data = canonicalizeDraftData(JSON.parse(draftData));
                        if (data.ObstacleName) {
                            data.ObstacleName = data.ObstacleName.toString().trim();
                        }

                        if (!data.ObstacleName && data.obstacleName) {
                            data.ObstacleName = data.obstacleName.toString().trim();
                        }
                        data.draftKey = draftKey;

                        const pageType = document.getElementById('hiddenObstacleType')?.value || '';
                        const draftType = typeof data.ObstacleType === 'string' ? data.ObstacleType : '';
                        const normalizedPageType = pageType.toLowerCase();
                        const normalizedDraftType = draftType.toLowerCase();

                        if (normalizedDraftType && normalizedPageType && normalizedDraftType !== normalizedPageType) {
                            const params = new URLSearchParams(window.location.search);
                            params.set('draft', draftKey);
                            params.set('type', normalizedDraftType);

                            if (data.Coordinates) {
                                params.set('coordinates', data.Coordinates);
                            }

                            const pointCount = derivePointCount(data);
                            if (!Number.isNaN(pointCount) && pointCount >= 0) {
                                params.set('count', pointCount.toString());
                            }

                            const newUrl = `${window.location.pathname}?${params.toString()}`;
                            if (newUrl !== window.location.href) {
                                window.location.replace(newUrl);
                                return;
                            }
                        }

                        applyDraftToForm(data);

                        const currentDraftKeyField = document.getElementById('currentDraftKey');
                        if (currentDraftKeyField) {
                            currentDraftKeyField.value = draftKey;
                        }

                        const notification = document.getElementById('draftNotification');
                        notification.textContent = 'Draft loaded successfully!';
                        showDraftNotification();
                        notification.textContent = 'Draft saved successfully!';
                        
                    } catch (e) {
                        console.error('Error loading draft:', e);
                    }
                }
            }
        }
        
        function updateMapSummaryFromData(data = {}) {
            const typeRaw = (data.ObstacleType || '').toString();
            const typeLower = typeRaw ? typeRaw.toLowerCase() : 'unknown';
            const formattedType = formatObstacleTypeLabel(typeRaw);
            const typeUpper = formattedType.toUpperCase();

            const heading = document.getElementById('summaryTypeHeading');
            if (heading) {
                heading.textContent = typeUpper;
            }

            const typeText = document.getElementById('summaryTypeText');
            if (typeText) {
                typeText.textContent = typeUpper;
            }

            const typeBadge = document.getElementById('summaryTypeBadge');
            if (typeBadge) {
                const badgeType = ['mast', 'powerline', 'other'].includes(typeLower) ? typeLower : 'other';
                typeBadge.textContent = formattedType;
                typeBadge.className = `obstacle-type-badge badge-${badgeType}`;
            }

            const coordinatesValue = typeof data.Coordinates === 'string'
                ? data.Coordinates
                : JSON.stringify(data.Coordinates ?? []);

            const hiddenCoordinatesField = document.getElementById('hiddenCoordinates');
            if (hiddenCoordinatesField) {
                hiddenCoordinatesField.value = coordinatesValue || '[]';
            }

            renderCoordinatesFromJson(coordinatesValue);

            const pointCount = derivePointCount({
                PointCount: data.PointCount,
                Coordinates: coordinatesValue
            });

            const pointCountSpan = document.getElementById('summaryPointCount');
            if (pointCountSpan) {
                pointCountSpan.textContent = pointCount;
            }

            const hiddenPointCountField = document.getElementById('hiddenPointCount');
            if (hiddenPointCountField) {
                hiddenPointCountField.value = pointCount;
            }

            const hiddenTypeField = document.getElementById('hiddenObstacleType');
            if (hiddenTypeField) {
                hiddenTypeField.value = typeRaw;
            }
        }

        function formatObstacleTypeLabel(value) {
            if (!value) {
                return 'Draft';
            }

            const lower = value.toLowerCase();
            switch (lower) {
                case 'mast':
                    return 'Mast';
                case 'powerline':
                    return 'Power Line';
                case 'other':
                    return 'Other';
                default:
                    return value.charAt(0).toUpperCase() + value.slice(1);
            }
        }

        setInterval(() => {
            const form = document.querySelector('form');
            if (!form) {
                return;
            }

            const formData = new FormData(form);
            let hasContent = false;

            for (let value of formData.values()) {
                if (value && value.toString().trim() !== '') {
                    hasContent = true;
                    break;
                }
            }

            if (hasContent) {
                saveDraftSilently();
            }
        }, 30000);

        function saveDraftSilently() {
            const draftData = buildDraftData({ autoSave: true });
            if (!draftData) {
                return;
            }

            const typeSegment = (draftData.ObstacleType || 'obstacle').toLowerCase().replace(/\s+/g, '-');
            const draftKey = `autosave_${typeSegment}_${Date.now()}`;
            localStorage.setItem(draftKey, JSON.stringify(draftData));

            const autoSaves = Object.keys(localStorage).filter(key => key.startsWith('autosave_'));
            if (autoSaves.length > 3) {
                autoSaves.sort();
                localStorage.removeItem(autoSaves[0]);
            }
        }
    </script>
}
