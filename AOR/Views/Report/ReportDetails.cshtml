@model AOR.Models.ReportModel

@{
    ViewData["Title"] = "Report details";
    Layout = "_Layout";
}

<link rel="stylesheet" href="~/css/Report/ReportDetails.css" />
<section class="container">
    @{
        var activeRole = User.FindFirst("ActiveRole")?.Value;
    }
    <div class="details-header">
        @if (activeRole == "Registrar" || activeRole == "Admin")
        {
            <a href="/Registrar" class="btn btn-primary back-button">Back to Overview</a>
        }
        @if (activeRole == "Crew")
        {
            <a href="/Crew" class="btn btn-primary back-button">Back to Map</a>
            <a href="/Report/MyReports" class="btn btn-secondary right-button">Your reports</a>
        }
        <h1>Report details</h1>
    </div>
    

    <div class="details-grid">
        
        @{
            var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var isOwner = currentUserId == Model.UserId;
            var isAdminOrRegistrar = activeRole == "Admin" || activeRole == "Registrar";
            var canViewUser = isOwner || isAdminOrRegistrar;
        }
        
        @if (canViewUser && Model.User != null)
        {
            <div class="detail-card">
                <div class="detail-label">User</div>
                <div class="detail-value">@Model.User.UserName</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Organization</div>
                <div class="detail-value">@(Model.User.Organization.OrgName)</div>
            </div>
            
        }
        
        
        
        <div class="detail-card">
            <div class="detail-label">Registered</div>
            <div class="detail-value">@Model.CreatedAt.ToString("dd.MM.yyyy HH:mm")</div>
        </div>
        
        <div class="detail-card">
            <div class="detail-label">Status</div>
            <div class="detail-value">
                @{
                    var statusText = Model.Status?.Status ?? "Pending";
                    var badgeClass = statusText.ToLower() switch
                    {
                        "approved" => "status-badge approved",
                        "rejected" => "status-badge rejected",
                        _ => "status-badge pending"
                    };
                }
                <span class="@badgeClass">@statusText</span>
            </div>
        </div>
        
        <div class="detail-card">
            <div class="detail-label">Type</div>
            <div class="detail-value">@Model.Obstacle.ObstacleType.ToUpper()</div>
        </div>

        <div class="detail-card">
            <div class="detail-label">Name</div>
            <div class="detail-value">@Model.Obstacle.ObstacleName</div>
        </div>
        
        @if (Model.Obstacle.ObstacleHeight.HasValue)
        {
            <div class="detail-card">
                <div class="detail-label">Height</div>
                <div class="detail-value">
                    @Model.Obstacle.ObstacleHeight.Value.ToString("F1") m
                    <span style="color: #6b7280; font-size: 0.875rem;">
                        (â‰ˆ @((Model.Obstacle.ObstacleHeight.Value * 3.28084).ToString("F1")) ft)
                    </span>
                </div>
            </div>
        }
        
        @if (Model.Obstacle.ObstacleType.ToLower() == "line")
        {
            @if (Model.Obstacle.WireCount.HasValue)
            {
                <div class="detail-card">
                    <div class="detail-label">Wire Count</div>
                    <div class="detail-value">@Model.Obstacle.WireCount wires</div>
                </div>
            }
        }
        else if (Model.Obstacle.ObstacleType.ToLower() == "mast")
        {
            @if (!string.IsNullOrEmpty(Model.Obstacle.MastType))
            {
                <div class="detail-card">
                    <div class="detail-label">Mast Type</div>
                    <div class="detail-value">@Model.Obstacle.MastType</div>
                </div>
            }

            @if (Model.Obstacle.HasLighting.HasValue)
            {
                <div class="detail-card">
                    <div class="detail-label">Aviation Lighting</div>
                    <div class="detail-value">@(Model.Obstacle.HasLighting.Value ? "Yes" : "No")</div>
                </div>
            }
        }
        else
        {
            @if (!string.IsNullOrEmpty(Model.Obstacle.Category))
            {
                <div class="detail-card">
                    <div class="detail-label">Category</div>
                    <div class="detail-value">@Model.Obstacle.Category</div>
                </div>
            }
        }
    </div>
    
    @if (!string.IsNullOrEmpty(Model.Obstacle.ObstacleDescription))
    {
        <div class="detail-card" style="margin-bottom: 24px;">
            <div class="detail-label">Description</div>
            <div class="detail-value">@Model.Obstacle.ObstacleDescription</div>
        </div>
    }
    
    @if (!string.IsNullOrEmpty(Model.Obstacle.Coordinates) && Model.Obstacle.Coordinates != "[]")
    {
        <div class="coordinates-section">
            <h3 style="margin: 0 0 12px 0; color: #0c4a6e;">GPS Coordinates</h3>
            <div class="coordinates-list" id="coordinates-display"></div>
        </div>
    }
    <input type="hidden" id="reportCoordinates" value="@Model.Obstacle.Coordinates" />
    <input type="hidden" id="reportObstacleType" value="@Model.Obstacle.ObstacleType" />
    <div style="margin-bottom: 36px;">
        <div id="map-wrapper">
            <div id="report-map" style="border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0;"></div>
        </div>
    </div>
    
</section>

@section Scripts {
    <!-- Leaflet CSS -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin="">
    </script>

    <script src="~/js/Report/ReportDetails.js"></script>
}
