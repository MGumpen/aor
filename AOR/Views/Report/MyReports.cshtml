@model IEnumerable<AOR.Models.ReportModel>
@using System.Security.Claims

@{
    ViewData["Title"] = "My Reports";
    Layout = "_Layout";
    string currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier) ?? string.Empty;
}

<link rel="stylesheet" href="~/css/Report/MyReports.css" />


<section class="container">
    <div class="header">
        <h1>My Reports</h1>
        <p style="color: #64748b;">Overview of obstacles you have reported</p>
    </div>
    
    <div class="actions-bar">
        <a href="/Crew" class="btn btn-primary">Back to map</a>
        <div class="stats">
            <div><strong>Total:</strong> @(Model == null ? 0 : Model.Count()) reports</div>
            <div><strong>Lines:</strong> @(Model == null ? 0 : Model.Count(x => x.Obstacle != null && !string.IsNullOrEmpty(x.Obstacle.ObstacleType) && x.Obstacle.ObstacleType.ToLower() == "line"))</div>
            <div><strong>Masts:</strong> @(Model == null ? 0 : Model.Count(x => x.Obstacle != null && !string.IsNullOrEmpty(x.Obstacle.ObstacleType) && x.Obstacle.ObstacleType.ToLower() == "mast"))</div>
            <div><strong>Other:</strong> @(Model == null ? 0 : Model.Count(x => x.Obstacle != null && !string.IsNullOrEmpty(x.Obstacle.ObstacleType) && x.Obstacle.ObstacleType.ToLower() == "other"))</div>
            <div id="draftsStats" style="display:none;"><strong>Drafts:</strong> <span id="draftsNumber">0</span></div>
        </div>
    </div>
    
    <div class="obstacles-grid" id="draftsContainer" style="display: none; margin-bottom: 24px;"></div>

    @if (Model != null && Model.Any())
    {
        <div class="obstacles-grid">
            @foreach (var report in Model.OrderByDescending(x => x.CreatedAt))
            {
                <div class="obstacle-card">
                    <div class="obstacle-header">
                        <h3 class="obstacle-name">@report.Obstacle?.ObstacleName</h3>
                        @{
                            var type = (report.Obstacle?.ObstacleType ?? "other").ToLower();
                        }
                        <span class="obstacle-type-badge badge-@type">
                            @report.Obstacle?.ObstacleType
                        </span>
                    </div>
                    
                    <div class="obstacle-details">
                        @if (report.Obstacle?.ObstacleHeight.HasValue == true)
                        {
                            <div class="detail-item">
                                <div class="detail-label">Height:</div>
                                <div class="detail-value">@($"{report.Obstacle.ObstacleHeight.Value:F1} m")</div>
                            </div>
                        }
                        
                        <div class="detail-item">
                            <div class="detail-label">Points:</div>
                            <div class="detail-value">@report.Obstacle?.PointCount</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="detail-label">Registered:</div>
                            <div class="detail-value">@report.CreatedAt.ToString("dd.MM.yyyy")</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="detail-label">Status:</div>
                            <div class="detail-value">
                                @{
                                    var statusText = report.Status?.Status ?? "Pending";
                                    var badgeClass = statusText.ToLower() switch
                                    {
                                        "approved" => "status-badge status-badge-approved",
                                        "rejected" => "status-badge status-badge-rejected",
                                        _ => "status-badge status-badge-pending"
                                    };
                                }
                                <span class="@badgeClass">@statusText</span>
                            </div>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(report.Obstacle?.ObstacleType)
                             && report.Obstacle.ObstacleType.ToLower() == "mast"
                             && !string.IsNullOrEmpty(report.Obstacle.MastType))
                        {
                            <div class="detail-item">
                                <div class="detail-label">Type:</div>
                                <div class="detail-value">@report.Obstacle.MastType</div>
                            </div>
                        }
                    </div>
                    
                    @if (!string.IsNullOrEmpty(report.Obstacle?.ObstacleDescription))
                    {
                        <div class="obstacle-description">
                            @(report.Obstacle.ObstacleDescription.Length > 100 ? 
                              report.Obstacle.ObstacleDescription.Substring(0, 100) + "..." : 
                              report.Obstacle.ObstacleDescription)
                        </div>
                    }
                    
                    <div class="report-actions">
                        <a asp-controller="Report" asp-action="ReportDetails" asp-route-id="@report.ReportId" class="btn-small btn-details">View Details</a>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">üìç</div>
            <h3>No Reports Found</h3>
            <p>You haven't reported any obstacles yet.</p>
        </div>
    }
</section>

<script src="~/js/Report/MyReports.js"></script>
